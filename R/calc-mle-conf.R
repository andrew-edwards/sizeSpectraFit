##' Calculate maximum likelihood estimate and 95\% confidence
##'  interval
##'
##' Calculate maximum likelihood estimate of a parameter and its 95\% confidence
##'  interval using the profile log-likelihood method, for a given
##'  negative log-likelihood function and its arguments (other parameters and data).
##' TODO Will likely give warnings that can safely be ignored (see
##'  `suppress.warnings` description below). Decide what to do, maybe like for hdiAnalysis.
##' This should be a general function, i.e. not just applicable to size
##'  spectra. TODO check that I did that.
##'
##' @param this_neg_ll_fn negative log-likelihood function that take arguments
##'  (parameters and data) in ... and returns a negative
##'  log-likelihood value.
##' @param p starting point to calculate the maximum likelihood estimate
##' @param vec vector of values over which to test the negative log-likelihood
##'   to construct the confidence interval. If `NULL` (users will probably just
##'   want to stick with this default) then it will get
##'   automatically created, based on `vec_diff` and `vec_inc`. If the resulting
##'   confidence interval bounds including one of the endpoints of `vec`, then
##'   `vec` is automatically expanded until it encompasses the confidence
##'   interval (regardless of whether it was manually specified or `NULL`).
##' @param vec_diff if `vec` is `NULL`, the range over which to calculate the
##'   negative log-likelihood
##'  to construct the confidence interval. Default is 0.5 and a symmetric
##'  range is tested for fitting size spectra, since for movement data
##'  sets in Table 2 of Edwards (2011; 92(6):1247-1257) the intervals were
##'  symmetric, so symmetric seems a good start. TODO may need updating
##' @param vec_inc if `vec` is `NULL`, the increments of the vector to calculate
##'   the negative log-likelihood to construct the confidence interval. The
##'   accuracy of the resulting bounds
##'  will depend on this. Note that a resulting interval of, say,
##'  (-2.123, -1.987) means that that interval is contained within the
##'  true 95\% interval, which is itself contained within (-2.124, -1.986).
##'  The true bounds lie between the stated lower bounds and between
##'  the stated upper bounds. So reduce `vec_inc` if further accuracy is
##'   needed. Also used even if `vec` is specified by the user but then needs to
##'   be expanded (see `vec`).
##' @param suppress_warnings TODO decide. If TRUE then suppress warnings from the `nlm()`
##'   calculations; for the `MEPS_IBTS_MLEbins` vignette these occur a lot, and
##'   are always:
##'   `Warning in nlm(f = negll.fn, p = p, ...) :
##'    NA/Inf replaced by maximum positive value`. The same warning often happens in other
##'   situations also. It is due to the likelihood function blowing up,
##'   presumably when searching some very very very unlikely region of paramater space.
##' @param ... further arguments (including parameters and data) to `negll_fn()`
##' @return       list containing:
##'   * MLE: the maximum likelihood estimate
##'   * conf: the 95\% confidence interval of the MLE
##' @export
##' @author Andrew Edwards
calc_mle_conf <- function(this_neg_ll_fn,   # needed to avoid partial matching
                                        # with n
                          p,
                          vec = NULL,
                          vec_diff = 0.5,
                          vec_inc = 0.00001,
                          suppress_warnings = FALSE,
                          ...){

  # calcLike was:  TODO decide about the warnings
  if(suppress_warnings){
    min_neg_ll <- suppressWarnings(nlm(f = this_neg_ll_fn,
                                       p=p,
                                       ...))
  } else {
    min_neg_ll <- nlm(f = this_neg_ll_fn,
                      p = p,
                      ...)
  }

  mle = min_neg_ll$estimate

  if(is.null(vec)){
    vec <- seq(mle - vec_diff,
               mle + vec_diff,
               by = vec_inc)
  }

  conf <- calc_confidence_interval(this_neg_ll_fn = this_neg_ll_fn,
                                   min_neg_ll_value = min_neg_ll$minimum,
                                     # x = x,
                                     # n = n,
                                     # x_min = x_min,
                                     # x_max = x_max,
                                     # sum_log_x = sum_log_x,
                                     vec = vec,
                                     ...)

  # If confidence interval hits a bound then redo it over a larger range
  while(conf[1] == min(vec) | conf[2] == max(vec)){
    vec <- seq(min(vec) - 0.5,
                 max(vec) + 0.5,
                 vec_inc)

    conf <- calc_confidence_interval(this_neg_ll_fn = this_neg_ll_fn,  # TODO same as above
                                       min_neg_ll_value = min_neg_ll$minimum,
#                                       x = x,
#                                       n = n,
#                                       x_min = x_min,
#                                       x_max = x_max,
#                                       sum_log_x = sum_log_x,
                                       vec = vec,
                                       ...)
  }


#  conf = prof_like(negll_fn = negll_fn,
#                   mle = mle,
#                   min_negll = min_neg_ll$minimum,
#                   vec_diff = vec_diff,
#                   ...)

  res <- list(mle = mle,
              conf = conf)
  return(res)
}
