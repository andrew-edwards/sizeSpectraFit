---
title: "Determining length resolutions for Mediterranean data"
author: "Andrew Edwards and Juliana Zabala"
output: pdf_document
fontsize: 12pt
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "",
  cache = FALSE,
  cache_path = "med-analysis-length-resolution-cache/",
  fig.path = "med-analysis-length-resolution-figs-cache/",
  fig.width = 7,
  fig.height = 9
)
  # comment = "#>",
```

```{r, build, echo = FALSE, eval = FALSE}
# To build either run this line or click knit button in RStudio:
rmarkdown::render("med-analysis-length-resolution.Rmd")
```

```{r, packages, echo = FALSE, cache = FALSE}
library(dplyr)
load_all()
#library(sizeSpectra2)    # Need latest version
```

When doing the MLEbins vignette Andy realised that he had not properly considered the
length resolutions. Doing the analysis here.

Summary (from the analyses below):

**Crustacea for baseline were to nearest 0.01 mm, while crustacea for FG and NTR
were measured to nearest 0.1 mm (with a very few minor exceptions).**

**All non-crustacea are measured to nearest 1 mm (except one measurement that
doesn't matter), as verified below.**


## Data

Raw data of measurement are saved in the package as:
```{r medcalcs}
options(pillar.sigfig = 7)   # show 7 sig figs when printing tibbles
mediterranean_data
summary(mediterranean_data)
```
which we want to fit the size spectrum for each strata-group
combination.

Lengths are in mm. I had originally
misintepreted values as integer lengths assumed to be measured to nearest mm and lengths
with decimals assumed to be measured to 0.01 mm (assuming this will mis-specify, presumably
1%, a few mm ones,
but that's okay). But it's group-specific, as investigated below.

Lengths are assumed to be midpoints (e.g. 10 mm represents
9.5-10.5 mm).

Juliana had said: The lengths with 0.01mm accuracy are all measured crustaceans [Andy:
but it turns out that not all crustaceans are measured to 0.01 mm, see below], as
they're typically small and its the standard to measure them with a vernier
caliper. All other species were measured to the 1mm accuracy, as we used a
standard lab metric tape. So if we have 27 its correct to say it is 27.00. With
this in mind, I would define b) 26.5 - 27.5 mm as the bin value for 27.00.

For the 0.01 mm accuracy it really isn't going to make much difference
exactly how
we define the bin, so say 26.13 is 26.125-26.135 for consistency. (Have to
assume this for `calc_max_of_bin()` and need a weight range for each length for MLEbins).

## Investigate resolutions of length measurements

Need to investigate each strata of crustacea, and then everything else.

### Crustacea baseline

```{r crustaceabaseline}
crust_baseline <- dplyr::filter(mediterranean_data,
                                strata == "baseline",
                                group == "Crustacea")
crust_baseline

table(crust_baseline$length)[1:100]      # looks like nearest 0.01 mm, though
                                         # quite a few 0.1 mm

table(crust_baseline$length)[998:1097]   # looks like nearest 0.01 mm
```

That first table looks like quite a few 0.1 mm, but turns out only for a few
species and not loads of measurements (see below).

Species measured to 0.01:

```{r, crustaceabasline2}
lengths <- as.numeric(names(table(crust_baseline$length)))
to_0.01 <- lengths[which((10 * lengths) %% 1 != 0)]
dplyr::filter(crust_baseline,
              length %in% to_0.01)
dplyr::filter(crust_baseline,
              length %in% to_0.01) %>% summary()
sp_to_0.01 <- dplyr::filter(crust_baseline,
                            length %in% to_0.01)$species %>% unique()
sp_to_0.01
```

Species not measured to 0.01:
```{r, crustaceabaseline3}
dplyr::filter(crust_baseline,
              !(length %in% to_0.01))

dplyr::filter(crust_baseline,
              !(length %in% to_0.01)) %>% summary()
```

So quite a few rows of measurements, about half of the number for 0.01
resolution.

```{r, crustaceabaseline4}
sp_not_to_0.01 <- dplyr::filter(crust_baseline,
                                !(length %in% to_0.01))$species %>% unique()
sp_not_to_0.01

intersect(sp_to_0.01, sp_not_to_0.01)

setdiff(sp_to_0.01, sp_not_to_0.01)   # sp in first but not in second vector; so sp
                                      # measured to 0.01 but never seem to be
                                      # measured to 0.1 (bit surprising this is
                                      # empty, since 1 in 100 of the first would
                                      # look like it's measured to 0.1)

setdiff(sp_not_to_0.01, sp_to_0.01)   # sp measured to 0.1 that don't seem to
                                      # get measured to 0.01

dplyr::filter(crust_baseline,
              species %in% setdiff(sp_not_to_0.01, sp_to_0.01)) %>%
  dplyr::arrange(species) %>%
  a()

```
So lots of measurements to 0.01 mm, looks like a mixture of species, and the
ones that are always to 0.1 (final tibble) is only 21 rows of measurements.

So just assume all measurements are to 0.01 mm, as only a few that seem to be
possibly to 0.1mm, and only 21 measurements then.

Seems conceivable that there might be some species that were measured sometimes to 0.01 and
sometimes to 0.1, but would have to examine by trawl which we don't have.


### Crustacea fishing grounds

```{r fgcrustacea2}
crust_fg <- dplyr::filter(mediterranean_data,
                          strata == "fg",
                          group == "Crustacea")

table(crust_fg$length)[1:100]   # crustacea FG, looks like nearest 0.1 mm
lengths <- as.numeric(names(table(crust_fg$length)))
to_0.01 <- lengths[which((10 * lengths) %% 1 != 0)]
dplyr::filter(crust_fg,
              length %in% to_0.01)
dplyr::filter(crust_fg,
              length %in% to_0.01)$length
```

So only 5 measurements to 0.01 mm, for one species. Overall, there are:
```{r onesp}
nrow(dplyr::filter(crust_fg, species == "Parapenaeus longirostris"))
```
measurements for that species. So let's simply just assume all crustacea FG were
to 0.1 mm (very minor approximation introduced for 5 measurements).


### Crustacea ntr

```{r crustaceantr}
crust_ntr <- dplyr::filter(mediterranean_data,
                                strata == "ntr",
                                group == "Crustacea")
crust_ntr

table(crust_ntr$length)[1:100]   # looks like nearest 0.1 mm
lengths <- as.numeric(names(table(crust_ntr$length)))
to_0.01 <- lengths[which((10 * lengths) %% 1 != 0)]
dplyr::filter(crust_ntr,
              length %in% to_0.01)
sp_to_0.01 <- dplyr::filter(crust_ntr,
                            length %in% to_0.01)$species %>% unique()
```
So only 3 measurements to 0.01 mm, for two different species. Overall, there are:
```{r twosp}
nrow(dplyr::filter(crust_fg, species == sp_to_0.01[1]))
nrow(dplyr::filter(crust_fg, species == sp_to_0.01[2]))
```
total measurement for those two species. So as for crustacea FG, simply assume
all crustacea NTR were to 0.1 mm
(very minor approximation introduced for 3 measurements).

### Non-crustacea

```{r noncrustacea}
non_crust <- dplyr::filter(mediterranean_data,
                           group != "Crustacea")
non_crust

table(non_crust$length)[1:100]   # looks like nearest 1 mm, except first one
lengths <- as.numeric(names(table(non_crust$length)))
to_0.01 <- lengths[which((10 * lengths) %% 1 != 0)]
to_0.01   # none
to_0.1 <- lengths[which(lengths %% 1 != 0)]
to_0.1

dplyr::filter(non_crust,
              length %in% to_0.1)
```
So only one non-crustacean measurement to 0.1 mm, and it's the smallest, and so
will get removed anyway (it has in the analysis where I had the length
resolutions not quite right, so will again).

So just assume all non-crustacea were indeed measured to nearest 1 mm.
