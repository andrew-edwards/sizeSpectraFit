---
title: "Analyses of Juliana's data based on her original R code and now using sizeSpectra2"
author: "Andrew Edwards"
output: pdf_document
fontsize: 12pt
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "",
  cache = TRUE,
  cache_path = "mediterranean-analysis-cache/",
  fig.path = "mediterranean-analysis-figs-cache/",
  fig.width = 7,
  fig.height = 6
)
  # comment = "#>",
```


```

```{r, build, echo = FALSE, eval = FALSE}
# To build either run this line or click knit button in RStudio:
rmarkdown::render("mediterranean-analysis.Rmd")
```

```{r, packages, echo = FALSE}
load_all()                 # Or comment out and uncomment next line if not in
                           #  the sizeSpectra2 folder.
# library(sizeSpectra2)    # Need latest version
library(tibble)
```

```{r, todo}
# TODO - things to confirm:
# 1. TODO - determine xmin and xmax, best to look at each in turn, maybe using
# hake lengths approach. See new determine_xmin and make_hist functions.
# 2. TODO - check all xmin xmax match the new spreadsheet.
# 3. TODO - want consistent x_min for all three crustacea, they are currently
#  different. Also need to think about x_min a little maybe. Andy could do the
# idea from the hake analyses to set x_min.
```

# Outline

HERE -- Wonder if I really should move to using MLEbins. Think I have all the
info. Yes - Juliana agrees. Keeping track here of steps, see section below for
write up and detailed plan

And she did use length-weight relationships for all individuals. And we can also
keep the standardisations also.

Next steps:
 D read MEPS again
 - look at code for that, use `MEPS_IBTS_all_min_100.Rmd` as template. Walk
   through it, understand what's needed.
 - back to data wrangling, need:
   - species-specific length-weight relationships
   - the necessary data from the spreadsheets. Load in and save the necessary
     columns for the analysis, doing the wrangling first.


HERE -- xmin should really be the minimum actual value within a bin that
contains the mode. No need for it to be a somewhat artificial bin break. That
was for MLE on individuals, need to think what to do for MLEbins.

HERE -- see Crustacea first. Doing amalgamation of all data to just determine xmin
(resulting size spectrum doesn't really make sense).

HERE -- see other HERE's down below; this won't build right now. Might when fix crustacea.

# Methods development (keeping notes here, then deleting as make progress)

sizeSpectra::negLL.PLB.bins.species() needs (just the first year here):

> dataBinForLike
# A tibble: 907 × 4
   SpecCode  wmin  wmax  Number
      <int> <dbl> <dbl>   <dbl>
 1   105814  315.  337. 0.00714
 2   105814  337.  360. 0.00714
 3   105814  434.  461. 0.00714
 4   105814  489.  518. 0.0293
 5   105814  518.  548. 0.0109
 6   105814  548.  579. 0.0113
 7   105814  612.  646. 0.0218
 8   105814  646.  680. 0.0188
 9   105814  680.  717. 0.0381
10   105814  717.  754. 0.0327
# ℹ 897 more rows

So actually have year/strata first also, to make it generalisable.


To get to that need to have already done the length-weight wrangling.

So steps are:
1. Get species-specific length-weight coefficients in a tibble. All we need is
   species, alpha, beta. Makes sense to have that on it's own, not repeated like
   in Fung data or Juliana's - this will what people would have, it's not part
   of collected data. Do for Fung and Juliana's in parallel. Maybe.

2. Get data in a tibble.   dataBinForLike is what was done for Fung data for
   first year.
3. Combine the two to end up with something in format of the above, but
   consistent with sizeSpectra2 formatting.
4. Copy the loglikelihood function over to sizeSpectra2.






# Data analysis


For each species group (that might not be the best word!) we look at the
baseline (data from 2017 before implementation of the no-take reserve), the
fishing grounds (data from 2021 after implementation of the no-take reserve but
outside of the reserve, abbreviated as 'fg') and the no-take reserve (data from 2021 after
implementation of the no-take reserve, inside the no-take reserve, abbreviated
as 'ntr').

Data are in the package in a list, which we will unpack here:
```{r unpackdata}
list2env(mediterranean_megafauna,
         .GlobalEnv)

# Plotting colours
col_baseline <- adjustcolor("blue4", alpha.f = 0.5)
col_fg <- adjustcolor("#00BF7D", alpha.f = 0.5)
col_ntr <- adjustcolor("#bc5090", alpha.f = 0.5)
```

We will step through each group in turn, then summarise the results to use at
the end.

TODO We also need to investigate the values to use for $x_\text{min}$ and
$x_\text{max}$ for each group, presumably wanting to keep them consistent
through time within a group.

USING lots of this as template for zabala-data-analysis.Rmd which does the
MLEbins method instead.

# Full community (though not going to use)

Showing that we need the stitching together idea later.

HERE return xmin and xmax from MLE calculation, also add an element describing
the method used, which will be helpful for users if it gets somewhat automated.;
Then no need to return from determine_xmin_and_fit_().

TODO `print.determine_xmin_and_fit()` or similar.

## Community baseline

```{r, communitybaseline}
range(x_community_baseline)

# Start with setting this bin_width to 1, but then decrease it if
# appropriate. Don't want to get too small, and this will depend on the data.
# Juliana had 0.2 as a minimum, so use that as bin width
res_community_baseline <- determine_xmin_and_fit(x_community_baseline,
                                                 bin_width = 0.2)

plot(res_community_baseline,
     xlim_hist = c(0, 20),
     main = "Community baseline")
```

```{r, tablecommunitybaseline, results = "asis"}
summary_mle_table(res_community_baseline)
```

Juliana had xmin of 0.2 and xmax of 1000. Leave for now as not going to use
anyway, but come back to if needed (she did have the justification for xmax
explained). Same values for FG and NTR. We do need same values for all
three. TODO think about.

## Community FG

```{r, communityfg}
range(x_community_fg)

res_community_fg <- determine_xmin_and_fit(x_community_fg,
                                           bin_width = 0.2)

plot(res_community_fg,
     xlim_hist = c(0, 20),
     main = "Community FG")
```

```{r, tablecommunityfg, results = "asis"}
summary_mle_table(res_community_fg)
```

## Community NTR

And for NTR:
```{r, communitntr}
range(x_community_ntr)

# Start with setting this bin_width to 1, but then decrease it if
# appropriate. Don't want to get too small, and this will depend on the data.
# Juliana had 0.2 as a minimum, so use that as bin width
res_community_ntr <- determine_xmin_and_fit(x_community_ntr,
                                           bin_width = 0.2)

plot(res_community_ntr,
     xlim_hist = c(0, 20),
     main = "Community NTR")
```

```{r, tablecommunityntr, results = "asis"}
summary_mle_table(res_community_ntr)
```

# Chondrichthyes

TODO Juliana removed lengths <100mm. Should really remove body masses < some
value. TODO. Look into reasoning.

## Chondrichthyes baseline

```{r, chondrichthyesbaseline}
range(x_chondr_baseline)

# Use 0.2 as looked good for full Community. Probably want to be consistent
# across everything.

res_chondr_baseline <- determine_xmin_and_fit(x_chondr_baseline,
                                              bin_width = 0.2)

plot(res_chondr_baseline,
     xlim_hist = c(0, 20),
     main = "Chondrichthyes baseline")
```

```{r, tablechondrbaseline, results = "asis"}
summary_mle_table(res_chondr_baseline)
```

## Chondrichthyes FG

This isn't great, shows need for communal xmin.

```{r, chondrichthyesfg}
range(x_chondr_fg)

# Increasing bin width here
res_chondr_fg <- determine_xmin_and_fit(x_chondr_fg,
                                           bin_width = 5)

plot(res_chondr_fg,
     xlim_hist = c(0, 20),
     main = "Chondrichthyes FG")
```

```{r, tablechondrfg, results = "asis"}
summary_mle_table(res_chondr_fg)
```

## Chondrichthyes NTR

And for NTR:
```{r, chondrichthyesntr}
range(x_chondr_ntr)

res_chondr_ntr <- determine_xmin_and_fit(x_chondr_ntr,
                                           bin_width = 0.2)

plot(res_chondr_ntr,
     xlim_hist = c(0, 20),
     main = "Chondrichthyes NTR")
```

```{r, tablechondrntr, results = "asis"}
summary_mle_table(res_chondr_ntr)
```


# Cephalopoda -- All

These results show clearly why Juliana then split up into small and large. Not
digging into results too much here then.

Juliana had xmin of 2 and xmax 200. See what the mode method gives first:

## Cephalopoda all baseline

```{r, cephbaseline}
range(x_ceph_all_baseline)

# Use 0.2 as looked good for full Community. Probably want to be consistent
# across everything.

res_ceph_all_baseline <- determine_xmin_and_fit(x_ceph_all_baseline,
                                                bin_width = 0.2)

plot(res_ceph_all_baseline,
     xlim_hist = c(0, 20),
     main = "Cephalopoda all baseline")
```

```{r, tablecephallbaseline, results = "asis"}
summary_mle_table(res_ceph_all_baseline)
```

## Cephalopoda all FG

```{r, cephallfg}
range(x_ceph_all_fg)

# Increasing bin width here
res_ceph_all_fg <- determine_xmin_and_fit(x_ceph_all_fg,
                                           bin_width = 0.2)

plot(res_ceph_all_fg,
     xlim_hist = c(0, 20),
     main = "Cephalopoda all FG")
```

```{r, tablecephallfg, results = "asis"}
summary_mle_table(res_ceph_all_fg)
```

## Cephalopoda all NTR

And for NTR:
```{r, cephallntr}
range(x_ceph_all_ntr)

res_ceph_all_ntr <- determine_xmin_and_fit(x_ceph_all_ntr,
                                           bin_width = 0.2)

plot(res_ceph_all_ntr,
     xlim_hist = c(0, 20),
     main = "Cephalopoda all NTR")
```

```{r, tablecephallntr, results = "asis"}
summary_mle_table(res_ceph_all_ntr)
```

# Cephalopoda -- Large

Now doing just the large individuals. Probably should do MLEbin.

TODO and large/small cut off could be 20.

## Cephalopoda large baseline

```{r, cephlargebaseline}
range(x_ceph_large_baseline)

res_ceph_large_baseline <- determine_xmin_and_fit(x_ceph_large_baseline,
                                                  bin_width = 10)

plot(res_ceph_large_baseline,
     xlim_hist = c(0, 100),
     main = "Cephalopoda large baseline")
```

```{r, tablecephlargebaseline, results = "asis"}
summary_mle_table(res_ceph_large_baseline)
```

## Cephalopoda large FG

```{r, cephlargefg}
range(x_ceph_large_fg)

# Increasing bin width here
res_ceph_large_fg <- determine_xmin_and_fit(x_ceph_large_fg,
                                           bin_width = 10)

plot(res_ceph_large_fg,
     xlim_hist = c(0, 100),
     main = "Cephalopoda large FG")
```

```{r, tablecephlargefg, results = "asis"}
summary_mle_table(res_ceph_large_fg)
```

## Cephalopoda large NTR

And for NTR:
```{r, cephlargentr}
range(x_ceph_large_ntr)

res_ceph_large_ntr <- determine_xmin_and_fit(x_ceph_large_ntr,
                                             bin_width = 10)

plot(res_ceph_large_ntr,
     xlim_hist = c(0, 100),
     main = "Cephalopoda large NTR")
```

```{r, tablecephlargentr, results = "asis"}
summary_mle_table(res_ceph_large_ntr)
```

# Cephalopoda -- Small

Now doing just the small individuals. Probably should do MLEbin.

TODO and large/small cut off could be 20.

## Cephalopoda small baseline

```{r, cephsmallbaseline}
range(x_ceph_small_baseline)

res_ceph_small_baseline <- determine_xmin_and_fit(x_ceph_small_baseline,
                                                  bin_width = 1)

plot(res_ceph_small_baseline,
     xlim_hist = c(0, 10),
     main = "Cephalopoda small baseline")
```

```{r, tablecephsmallbaseline, results = "asis"}
summary_mle_table(res_ceph_small_baseline)
```

## Cephalopoda small FG

```{r, cephsmallfg}
range(x_ceph_small_fg)

# Increasing bin width here
res_ceph_small_fg <- determine_xmin_and_fit(x_ceph_small_fg,
                                           bin_width = 1)

plot(res_ceph_small_fg,
     xlim_hist = c(0, 10),
     main = "Cephalopoda small FG")
```

```{r, tablecephsmallfg, results = "asis"}
summary_mle_table(res_ceph_small_fg)
```

## Cephalopoda small NTR

And for NTR:
```{r, cephsmallntr}
range(x_ceph_small_ntr)

res_ceph_small_ntr <- determine_xmin_and_fit(x_ceph_small_ntr,
                                             bin_width = 1)

plot(res_ceph_small_ntr,
     xlim_hist = c(0, 10),
     main = "Cephalopoda small NTR")
```

```{r, tablecephsmallntr, results = "asis"}
summary_mle_table(res_ceph_small_ntr)
```


# Actinopterygii

TODO Juliana removed lengths <100mm. Should really remove body masses < some
value. TODO. Look into reasoning.

## Actinopterygii baseline

```{r, actinichthyesbaseline}
range(x_actin_baseline)

# Use 0.2 as looked good for full Community. Probably want to be consistent
# across everything.

res_actin_baseline <- determine_xmin_and_fit(x_actin_baseline,
                                              bin_width = 0.2)

plot(res_actin_baseline,
     xlim_hist = c(0, 20),
     main = "Actinopterygii baseline")
```

```{r, tableactinbaseline, results = "asis"}
summary_mle_table(res_actin_baseline)
```

## Actinopterygii FG

```{r, actinichthyesfg}
range(x_actin_fg)

# Increasing bin width here
res_actin_fg <- determine_xmin_and_fit(x_actin_fg,
                                           bin_width = 5)

plot(res_actin_fg,
     xlim_hist = c(0, 20),
     main = "Actinopterygii FG")
```

```{r, tableactinfg, results = "asis"}
summary_mle_table(res_actin_fg)
```

## Actinopterygii NTR

And for NTR:
```{r, actinichthyesntr}
range(x_actin_ntr)

res_actin_ntr <- determine_xmin_and_fit(x_actin_ntr,
                                           bin_width = 0.2)

plot(res_actin_ntr,
     xlim_hist = c(0, 20),
     main = "Actinopterygii NTR")
```

```{r, tableactinntr, results = "asis"}
summary_mle_table(res_actin_ntr)
```

# Crustacea

Juliana had xmin as 0.4 for FG and 0.3 for NTR; check what it was for baseline.

## Crustacea amalgamate

```{r, crustamalgamate}
x_crust_amalgamate <- c(x_crust_baseline,
                        x_crust_fg,
                        x_crust_ntr)

range(x_crust_amalgamate)

res_crust_amalgamate <- determine_xmin_and_fit(x_crust_amalgamate,
                                               bin_width = 0.4)

plot(res_crust_amalgamate,
     xlim_hist = c(0, 20),
     main = "Crustacea amalgamate")
x_min_crust <- res_crust_amalgamate$x_min
x_max_crust <- res_crust_amalgamate$x_max
```

```{r, tablecrustamalgamate, results = "asis"}
summary_mle_table(res_crust_amalgamate)
```


## Crustacea baseline

```{r, crustichthyesbaseline}
range(x_crust_baseline)

# Use 0.2 as looked good for full Community. Probably want to be consistent
# across everything.

# res_crust_baseline <- determine_xmin_and_fit(x_crust_baseline,
#                                              bin_width = 0.2,
#                                             x_min = x_min_crust)

res_crust_baseline <- fit_size_spectrum(x_crust_baseline,
                                        x_min = x_min_crust,
                                        x_max = x_max_crust)

plot(res_crust_baseline,
     # xlim_hist = c(0, 20),
     main = "Crustacea baseline")
```

```{r, tablecrustbaseline, results = "asis"}
summary_mle_table(res_crust_baseline)   # HERE won't work now, need a new type
```

## Crustacea FG

```{r, crustichthyesfg}
range(x_crust_fg)

res_crust_fg <- fit_size_spectrum(x_crust_fg,
                                        x_min = x_min_crust,
                                        x_max = x_max_crust)

plot(res_crust_fg,
     # xlim_hist = c(0, 20),
     main = "Crustacea FG")



HERE
# TODO remove this I expect:

# Increasing bin width here
res_crust_fg <- determine_xmin_and_fit(x_crust_fg,
                                           bin_width = 0.2)

plot(res_crust_fg,
     xlim_hist = c(0, 20),
     main = "Crustacea FG")
```

```{r, tablecrustfg, results = "asis"}
summary_mle_table(res_crust_fg)
```

## Crustacea NTR

And for NTR:
```{r, crustntr}
range(x_crust_ntr)


res_crust_ntr <- fit_size_spectrum(x_crust_ntr,
                                        x_min = x_min_crust,
                                        x_max = x_max_crust)

plot(res_crust_ntr,
     # xlim_hist = c(0, 20),
     main = "Crustacea NTR")



# HERE won't need, as above:
res_crust_ntr <- determine_xmin_and_fit(x_crust_ntr,
                                           bin_width = 0.2)

plot(res_crust_ntr,
     xlim_hist = c(0, 20),
     main = "Crustacea NTR")
```

```{r, tablecrustntr, results = "asis"}
summary_mle_table(res_crust_ntr)
```


```{r, stop, cache = FALSE, eval = FALSE}
knitr::knit_exit()
```
