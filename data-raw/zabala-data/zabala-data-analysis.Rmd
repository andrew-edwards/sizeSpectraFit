---
title: "Analysing Juliana Zabala's data having wrangled it"
author: "Andrew Edwards and Juliana Zabala"
output: pdf_document
fontsize: 12pt
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "",
  cache = TRUE,
  cache_path = "zabala-data-analysis-cache/",
  fig.path = "zabala-data-analysis-figs-cache/",
  fig.width = 7,
  fig.height = 6
)
  # comment = "#>",
```

```{r, build, echo = FALSE, eval = FALSE}
# To build either run this line or click knit button in RStudio:
rmarkdown::render("zabala-data-analysis.Rmd")
```

```{r, packages, echo = FALSE, cache = FALSE}
library(dplyr)
load_all()
#library(sizeSpectra2)    # Need latest version
```

HERE TODO need to have `make_hist()` working for bin counts, not just counting
the number of binmin values. See `determine_xmin_and_fit_mlebins()` and then
rerun all this. Have saved previous .pdf.

Having saved the data in the package via `zabala-data.Rmd`, do the size spectra
analyses here. TODO then move this to report or vignette folder.

Copy and pasting analysis for a particular species group, then just find and
replacing the group name and the short name. Need to examine results and so
can't just make one giant function. The later groups are probably best to use as
templates as the analyses and code got refined along the way.

## Data
We have data and the length-weight coefficients in a standard form. Had analysed
in `zabala-data.Rmd` but want to reduce and functionalise those steps here.

TODO then use same functions to check
Fung results.

So we have three pieces of information. First is the measurements:
```{r medcalcs}
mediterranean_data
summary(mediterranean_data)
```
which we want to fit the size spectrum for each strata-group
combination. The data can have repeated measurements for the same
strata-group-length combination. We will aggregate such examples at the analysis
stage (could do earlier but best to keep data similar to original format).

Second piece is the definition of lengths. They are in mm, with integers measured to nearest mm and ones
with decimals measured to 0.01 mm (assuming this will mis-specify, presumably
1%, a few mm ones,
but that's okay). And the lengths assumed to be midpoints (e.g. 10 mm represents
9.5-10.5 mm).

Thirdly, we have species-specific length-weight coefficients.
```{r lwcoeffs}
mediterranean_length_weight_coefficients
```
which assume units of cm (not mm) and grammes.

## Analyses

Pick one combination first, functionalise what we can, then do each in turn as
do need to think about results and xmin choice (i.e. don't do one giant loop).

1. Create weight bins  TODO make a function that's general, but for now can just
do once to get results for each strata-group combination
```{r onestratagroup}
dat_bin_breaks <- calc_max_of_bin(mediterranean_data$length,
                                  bin_widths = c(0.01, 1))
dat_bin_breaks

dat_all <- cbind(mediterranean_data,
                 dat_bin_breaks) %>%
  tibble::as_tibble() %>%
  dplyr::rename(length_bin_min = bin_min,
                length_bin_max = bin_max)

dat_joined <- dplyr::left_join(dat_all,
                               mediterranean_length_weight_coefficients,
                               by = "species") %>%
  dplyr::mutate(weight_bin_min = alpha * (length_bin_min/10)^beta,
                weight_bin_max = alpha * (length_bin_max/10)^beta) %>%
  # remove species with no length-weight coefficients:
  dplyr::filter(!is.na(alpha)) %>%
  dplyr::mutate(strata = recode(strata,
                                TBA = "baseline",
                                FG = "fg",
                                MPA = "ntr"))       # lower case and be consistent

# TODO Could add argument for 10 depending on mm or cm

dat_joined[1:5, ] %>% a()

# Useful for users to be able to see all this, even though only some of it is
# needed for the likelihood fitting.
```

Just want to analyse one strata at a time. Do single baseline-actin here as an example
to help explain then functionalise and do each in turn.

```{r, analyse}
dat_baseline_actin <- dplyr::filter(dat_joined,
                                    strata == "baseline",
                                    group == "Actinopterygii")

# Now strip down to just what's needed, just need counts and bin definitions for
# weights, but keep species for understandability as am outputting the data in
# results, though am combining results of same species and bin_min (so do need
# species at this stage)...
dat_for_mlebins_pre <- dplyr::select(dat_baseline_actin,
                                     species,
                                     bin_count = number,
                                     bin_min = weight_bin_min,
                                     bin_max = weight_bin_max)

dat_for_mlebins_pre
xx <- table(table(dat_for_mlebins_pre$bin_min))
xx

dat_for_mlebins <- dplyr::summarise(dplyr::group_by(dat_for_mlebins_pre,
                                                    species,
                                                    bin_min,
                                                    bin_max),    # not needed
                                                      # for grouping but need to retain
                                    bin_count = sum(bin_count)) %>%
  dplyr::ungroup()

dat_for_mlebins

expect_equal(sum(xx),             # expected resulting number of rows, based on
                                  # unique counts
             nrow(dat_for_mlebins))


res_mlebins <- fit_size_spectrum(dat_for_mlebins)

res_mlebins
```



```{r plotmlebins}
plot(res_mlebins)   # worked, but hadn't done the groups yet.
```

That plot shows very few small organisms, emphasising the need to determine a
value for xmin.

### Determine xmin

This works for calculating xmin:

```{r xminandfit}
fit <- determine_xmin_and_fit_mlebins(dat_for_mlebins)

plot(fit, xlim_hist = c(0, 60))
```

## Functionalise

Repeat the above but write a function for it.

```{r functionalised}

data_baseline_actin <- mediterranean_for_mlebins(dat_joined,
                                                 strata_name = "baseline",
                                                 group_name = "Actinopterygii")

expect_equal(dat_for_mlebins,
             data_baseline_actin)
# So function matches what we did in detail above.

res_baseline_actin <- determine_xmin_and_fit_mlebins(data_baseline_actin)

expect_equal(fit,
             res_baseline_actin)
# And functionalised results match what we did above.
```

Now to plot the results:
```{r baselineactinplot}
plot(res_baseline_actin,
     xlim_hist = c(0, 60))
```

Okay, happy with functionalisation. Now to actually analyse the data sets in
turn. Do in the same order of Juliana's big figure.

Adapting the next sections from mediterranean-analysis.Rmd which used the MLE
method. Shapes of resulting ISD plots should somewhat resemble those that
Juliana produced, though we now have xmin more explicit and are using MLEbins.

Need to do these manually to check results, and decide on a communal xmin (and
maybe xmax TODO) for
each species group.

\clearpage

# Crustacea

Juliana had xmin as 0.4 for FG and 0.3 for NTR; check what it was for
baseline. But determining explicitly here.

## Crustacea baseline

```{r, crustbaseline}
data_crust_baseline <- mediterranean_for_mlebins(dat_joined,
                                                 group_name = "Crustacea",
                                                 strata_name = "baseline")


res_crust_baseline <- determine_xmin_and_fit_mlebins(data_crust_baseline)

res_crust_baseline$mlebins_fit     # full list includes histogram values, TODO
                                   # could make a print function
```

\clearpage

```{r, crustbaselineplot}
plot(res_crust_baseline,
     xlim_hist = c(0, 60),
     main = "Crustacea baseline")
```

## Crustacea FG

```{r, crustfg}
data_crust_fg <- mediterranean_for_mlebins(dat_joined,
                                           group_name = "Crustacea",
                                           strata_name = "fg")

res_crust_fg <- determine_xmin_and_fit_mlebins(data_crust_fg)

res_crust_fg$mlebins_fit
```

\clearpage

```{r, crustfgplot}
plot(res_crust_fg,
     xlim_hist = c(0, 60),
     main = "Crustacea FG")
```



## Crustacea NTR

```{r, crustntr}
data_crust_ntr <- mediterranean_for_mlebins(dat_joined,
                                            group_name = "Crustacea",
                                            strata_name = "ntr")

res_crust_ntr <- determine_xmin_and_fit_mlebins(data_crust_ntr)

res_crust_ntr$mlebins_fit
```

\clearpage

```{r, crustntrplot}
plot(res_crust_ntr,
     xlim_hist = c(0, 60),
     main = "Crustacea NTR")
```

Now to compare the three strata for Crustacea.

```{r, crustsumm}
res_crust_baseline$mlebins_fit$b_mle
res_crust_fg$mlebins_fit$b_mle
res_crust_ntr$mlebins_fit$b_mle

add_row_to_summary_table <- function(summary, res, group, strata){
  rbind(summary,
        dplyr::tibble("Group" = group,
                      "Strata" = strata,
                      "x_min" = res$mlebins_fit$x_min,
                      "x_max" = res$mlebins_fit$x_max,
                      "Low b" = res$mlebins_fit$b_conf[1],
                      "MLE b" = res$mlebins_fit$b_mle,
                      "High b" = res$mlebins_fit$b_conf[2]))
}

res_table_crust <- dplyr::tibble()
res_table_crust <- add_row_to_summary_table(res_table_crust,
                                      res_crust_baseline,
                                      "Crustacea",
                                      "Baseline")

res_table_crust <- add_row_to_summary_table(res_table_crust,
                                      res_crust_fg,
                                      "Crustacea",
                                      "fg")
res_table_crust <- add_row_to_summary_table(res_table_crust,
                                      res_crust_ntr,
                                      "Crustacea",
                                      "ntr")
```

Results combined are:

```{r, rescrusttable}
knitr::kable(res_table_crust, digits = 2)
```

## Global xmax for Crustacea

So doing the modal approach gave the same xmin for each strata, which is
great. xmax was set independently, so we should select the globally largest for
this species group.

```{r, crustxmax}
crust_xmax <- max(res_table_crust$x_max)
crust_xmax
```
We know that is for NTR, so redo the other two with this xmax value.

## Crustacea baseline with fixed xmax

```{r, crustbaselinexmax}
res_crust_baseline_fix_xmax <-
  determine_xmin_and_fit_mlebins(data_crust_baseline,
                                 x_max = crust_xmax)
```

\clearpage

```{r, crustbaselineplotxmax}
plot(res_crust_baseline_fix_xmax,
     xlim_hist = c(0, 60),
     main = "Crustacea baseline")
```

## Crustacea FG with fixed xmax

```{r, crustfgxmax}
res_crust_fg_fix_xmax <- determine_xmin_and_fit_mlebins(data_crust_fg,
                                                        x_max = crust_xmax)
```

\clearpage

```{r, crustfgplotxmax}
plot(res_crust_fg_fix_xmax,
     xlim_hist = c(0, 60),
     main = "Crustacea FG")
```

## Crustacea NTR figure again (communal xmax, which is based on max in NTR)

```{r, crustbaelinexmax}
res_crust_ntr_fix_xmax <- res_crust_ntr
```

```{r, crustntrplotxmax}
plot(res_crust_ntr,
     xlim_hist = c(0, 60),
     main = "Crustacea NTR")
```

Now to compare the three strata for Crustacea with xmax fixed:

```{r, crustsummfix}
res_table_crust_fix_xmax <- dplyr::tibble()
res_table_crust_fix_xmax <- add_row_to_summary_table(res_table_crust_fix_xmax,
                                      res_crust_baseline_fix_xmax,
                                      "Crustacea",
                                      "Baseline")

res_table_crust_fix_xmax <- add_row_to_summary_table(res_table_crust_fix_xmax,
                                      res_crust_fg_fix_xmax,
                                      "Crustacea",
                                      "fg")
res_table_crust_fix_xmax <- add_row_to_summary_table(res_table_crust_fix_xmax,
                                      res_crust_ntr,
                                      "Crustacea",
                                      "ntr")
```

Results combined are:

```{r, rescrusttablexmax}
knitr::kable(res_table_crust_fix_xmax, digits = 2)
```

So the FG size spectra steepened from the baseline, but the NTR remained
unchanged.

## Further communities

For each one, copy the above, find and replace relevant community name, but then
manually determine the xmax.


# Actinopterygii

Juliana removed lengths <100mm, so doing that here.

## Actinopterygii baseline

```{r, actinbaseline}
data_actin_baseline <- mediterranean_for_mlebins(dat_joined,
                                                 group_name = "Actinopterygii",
                                                 strata_name = "baseline",
                                                 minimum_length = 100)


res_actin_baseline <- determine_xmin_and_fit_mlebins(data_actin_baseline)

res_actin_baseline$mlebins_fit     # full list includes histogram values, TODO
                                   # could make a print function
```

\clearpage

```{r, actinbaselineplot}
plot(res_actin_baseline,
     xlim_hist = c(0, 60),
     main = "Actinopterygii baseline")
```

## Actinopterygii FG

```{r, actinfg}
data_actin_fg <- mediterranean_for_mlebins(dat_joined,
                                           group_name = "Actinopterygii",
                                           strata_name = "fg",
                                           minimum_length = 100)

res_actin_fg <- determine_xmin_and_fit_mlebins(data_actin_fg)

res_actin_fg$mlebins_fit
```

\clearpage

```{r, actinfgplot}
plot(res_actin_fg,
     xlim_hist = c(0, 60),
     main = "Actinopterygii FG")
```



## Actinopterygii NTR

```{r, actinntr}
data_actin_ntr <- mediterranean_for_mlebins(dat_joined,
                                            group_name = "Actinopterygii",
                                            strata_name = "ntr",
                                            minimum_length = 100)

res_actin_ntr <- determine_xmin_and_fit_mlebins(data_actin_ntr)

res_actin_ntr$mlebins_fit
```

\clearpage

```{r, actinntrplot}
plot(res_actin_ntr,
     xlim_hist = c(0, 60),
     main = "Actinopterygii NTR")
```

Now to compare the three strata for Actinopterygii.

```{r, actinsumm}
res_table_actin <- dplyr::tibble()
res_table_actin <- add_row_to_summary_table(res_table_actin,
                                      res_actin_baseline,
                                      "Actinopterygii",
                                      "Baseline")

res_table_actin <- add_row_to_summary_table(res_table_actin,
                                      res_actin_fg,
                                      "Actinopterygii",
                                      "fg")
res_table_actin <- add_row_to_summary_table(res_table_actin,
                                      res_actin_ntr,
                                      "Actinopterygii",
                                      "ntr")
```

Results combined are:

```{r, resactintable}
knitr::kable(res_table_actin, digits = 2)
```



## Global xmax for Actinopterygii

So doing the modal approach gave different xmin between baseline and other two;
should go with the largest of those. Though might give quite shallow power law
for baseline.

Alternative is to use xmin for the aggregated data, TODO try that also.

xmax was set independently, so we should select the globally largest for
this species group.

```{r, actinxmax}
actin_xmin <- max(res_table_actin$x_min)
actin_xmin
actin_xmax <- max(res_table_actin$x_max)
actin_xmax
```

## Actinopterygii baseline with fixed xmin and xmax

```{r, actinbaselinexmax}
res_actin_baseline_fix_xmax <-
  determine_xmin_and_fit_mlebins(data_actin_baseline,
                                 x_min = actin_xmin,
                                 x_max = actin_xmax)
```

\clearpage

```{r, actinbaselineplotxmax}
plot(res_actin_baseline_fix_xmax,
     xlim_hist = c(0, 60),
     main = "Actinopterygii baseline")
```

## Actinopterygii FG with fixed xmin and xmax

```{r, actinfgxmax}
res_actin_fg_fix_xmax <- determine_xmin_and_fit_mlebins(data_actin_fg,
                                                        x_min = actin_xmin,
                                                        x_max = actin_xmax)
```

\clearpage

```{r, actinfgplotxmax}
plot(res_actin_fg_fix_xmax,
     xlim_hist = c(0, 60),
     main = "Actinopterygii FG")
```

## Actinopterygii NTR with fixed xmin and xmax

TODO need to recompuate is xmin and
```{r, actinbaelinexmax}
res_actin_ntr_fix_xmax <- determine_xmin_and_fit_mlebins(data_actin_ntr,
                                                         x_min = actin_xmin,
                                                         x_max = actin_xmax)
```

```{r, actinntrplotxmax}
plot(res_actin_ntr,
     xlim_hist = c(0, 60),
     main = "Actinopterygii NTR")
```

Now to compare the three strata for Actinopterygii with xmax fixed:

```{r, actinsummfix}
res_table_actin_fix_xmax <- dplyr::tibble()
res_table_actin_fix_xmax <- add_row_to_summary_table(res_table_actin_fix_xmax,
                                      res_actin_baseline_fix_xmax,
                                      "Actinopterygii",
                                      "Baseline")

res_table_actin_fix_xmax <- add_row_to_summary_table(res_table_actin_fix_xmax,
                                      res_actin_fg_fix_xmax,
                                      "Actinopterygii",
                                      "fg")
res_table_actin_fix_xmax <- add_row_to_summary_table(res_table_actin_fix_xmax,
                                      res_actin_ntr_fix_xmax,
                                      "Actinopterygii",
                                      "ntr")
```

Results combined are:

```{r, resactintablexmax}
knitr::kable(res_table_actin_fix_xmax, digits = 2)
```


# Chondrichthyes

Juliana removed lengths <100mm, so doing that here.

## Chondrichthyes baseline

```{r, chondrbaseline}
data_chondr_baseline <- mediterranean_for_mlebins(dat_joined,
                                                 group_name = "Chondrichthyes",
                                                 strata_name = "baseline",
                                                 minimum_length = 100)


res_chondr_baseline <- determine_xmin_and_fit_mlebins(data_chondr_baseline)

res_chondr_baseline$mlebins_fit
```

\clearpage

```{r, chondrbaselineplot}
plot(res_chondr_baseline,
     xlim_hist = c(0, 60),
     main = "Chondrichthyes baseline")
```

## Chondrichthyes FG

```{r, chondrfg}
data_chondr_fg <- mediterranean_for_mlebins(dat_joined,
                                           group_name = "Chondrichthyes",
                                           strata_name = "fg",
                                           minimum_length = 100)

res_chondr_fg <- determine_xmin_and_fit_mlebins(data_chondr_fg)

res_chondr_fg$mlebins_fit
```

\clearpage

```{r, chondrfgplot}
plot(res_chondr_fg,
     xlim_hist = c(0, 60),
     main = "Chondrichthyes FG")
```



## Chondrichthyes NTR

```{r, chondrntr}
data_chondr_ntr <- mediterranean_for_mlebins(dat_joined,
                                            group_name = "Chondrichthyes",
                                            strata_name = "ntr",
                                            minimum_length = 100)

res_chondr_ntr <- determine_xmin_and_fit_mlebins(data_chondr_ntr)

res_chondr_ntr$mlebins_fit
```

\clearpage

```{r, chondrntrplot}
plot(res_chondr_ntr,
     xlim_hist = c(0, 60),
     main = "Chondrichthyes NTR")
```

Now to compare the three strata for Chondrichthyes.

```{r, chondrsumm}
res_table_chondr <- dplyr::tibble()
res_table_chondr <- add_row_to_summary_table(res_table_chondr,
                                      res_chondr_baseline,
                                      "Chondrichthyes",
                                      "Baseline")

res_table_chondr <- add_row_to_summary_table(res_table_chondr,
                                      res_chondr_fg,
                                      "Chondrichthyes",
                                      "fg")
res_table_chondr <- add_row_to_summary_table(res_table_chondr,
                                      res_chondr_ntr,
                                      "Chondrichthyes",
                                      "ntr")
```

Results combined are:

```{r, reschondrtable}
knitr::kable(res_table_chondr, digits = 2)
```



## Global xmax for Chondrichthyes

So doing the modal approach gave different xmin between baseline and other two;
should go with the largest of those. Though might give quite shallow power law
for baseline.

Alternative is to use xmin for the aggregated data, TODO try that also.

xmax was set independently, so we should select the globally largest for
this species group.

```{r, chondrxmax}
chondr_xmin <- max(res_table_chondr$x_min)
chondr_xmin
chondr_xmax <- max(res_table_chondr$x_max)
chondr_xmax
```

## Chondrichthyes baseline with fixed xmin and xmax

```{r, chondrbaselinexmax}
res_chondr_baseline_fix_xmax <-
  determine_xmin_and_fit_mlebins(data_chondr_baseline,
                                 x_min = chondr_xmin,
                                 x_max = chondr_xmax)
```

\clearpage

```{r, chondrbaselineplotxmax}
plot(res_chondr_baseline_fix_xmax,
     xlim_hist = c(0, 60),
     main = "Chondrichthyes baseline")
```

## Chondrichthyes FG with fixed xmin and xmax

```{r, chondrfgxmax}
res_chondr_fg_fix_xmax <- determine_xmin_and_fit_mlebins(data_chondr_fg,
                                                        x_min = chondr_xmin,
                                                        x_max = chondr_xmax)
```

\clearpage

```{r, chondrfgplotxmax}
plot(res_chondr_fg_fix_xmax,
     xlim_hist = c(0, 60),
     main = "Chondrichthyes FG")
```

## Chondrichthyes NTR with fixed xmin and xmax

TODO need to recompuate is xmin and
```{r, chondrbaelinexmax}
res_chondr_ntr_fix_xmax <- determine_xmin_and_fit_mlebins(data_chondr_ntr,
                                                         x_min = chondr_xmin,
                                                         x_max = chondr_xmax)
```

```{r, chondrntrplotxmax}
plot(res_chondr_ntr,
     xlim_hist = c(0, 60),
     main = "Chondrichthyes NTR")
```

Now to compare the three strata for Chondrichthyes with xmax fixed:

```{r, chondrsummfix}
res_table_chondr_fix_xmax <- dplyr::tibble()
res_table_chondr_fix_xmax <- add_row_to_summary_table(res_table_chondr_fix_xmax,
                                      res_chondr_baseline_fix_xmax,
                                      "Chondrichthyes",
                                      "Baseline")

res_table_chondr_fix_xmax <- add_row_to_summary_table(res_table_chondr_fix_xmax,
                                      res_chondr_fg_fix_xmax,
                                      "Chondrichthyes",
                                      "fg")
res_table_chondr_fix_xmax <- add_row_to_summary_table(res_table_chondr_fix_xmax,
                                      res_chondr_ntr_fix_xmax,
                                      "Chondrichthyes",
                                      "ntr")
```

Results combined are:

```{r, reschondrtablexmax}
knitr::kable(res_table_chondr_fix_xmax, digits = 2)
```


HERE

# Cephalopoda (all)

Juliana had xmin of 2 and xmax 200 (TODO check if lengths or weights). For
consistency we should first analyse the full data in one go first. Results for
MLE (not MLEbins) clearly showed the need to split up.

Small was body weights $<10$ and large was $>10$. First do all together; expect
it will show up the natural disconnect.

## Cephalopoda (all) baseline

```{r, cephallbaseline}
data_cephall_baseline <- mediterranean_for_mlebins(dat_joined,
                                                   group_name = "Cephalopoda",
                                                   strata_name = "baseline")

res_cephall_baseline <- determine_xmin_and_fit_mlebins(data_cephall_baseline)

res_cephall_baseline$mlebins_fit
```

\clearpage

```{r, cephallbaselineplot}
plot(res_cephall_baseline,
     xlim_hist = c(0, 60),
     main = "Cephalopoda (all) baseline")
```

## Cephalopoda (all) FG

```{r, cephallfg}
data_cephall_fg <- mediterranean_for_mlebins(dat_joined,
                                             group_name = "Cephalopoda",
                                             strata_name = "fg")

res_cephall_fg <- determine_xmin_and_fit_mlebins(data_cephall_fg)

res_cephall_fg$mlebins_fit
```

\clearpage

```{r, cephallfgplot}
plot(res_cephall_fg,
     xlim_hist = c(0, 60),
     main = "Cephalopoda (all) FG")
```



## Cephalopoda (all) NTR

```{r, cephallntr}
data_cephall_ntr <- mediterranean_for_mlebins(dat_joined,
                                            group_name = "Cephalopoda",
                                            strata_name = "ntr")

res_cephall_ntr <- determine_xmin_and_fit_mlebins(data_cephall_ntr)

res_cephall_ntr$mlebins_fit
```

\clearpage

```{r, cephallntrplot}
plot(res_cephall_ntr,
     xlim_hist = c(0, 60),
     main = "Cephalopoda (all) NTR")
```

Now to compare the three strata for Cephalopoda (all).

```{r, cephallsumm}
res_table_cephall <- dplyr::tibble()
res_table_cephall <- add_row_to_summary_table(res_table_cephall,
                                      res_cephall_baseline,
                                      "Cephalopoda",
                                      "Baseline")

res_table_cephall <- add_row_to_summary_table(res_table_cephall,
                                      res_cephall_fg,
                                      "Cephalopoda",
                                      "fg")
res_table_cephall <- add_row_to_summary_table(res_table_cephall,
                                      res_cephall_ntr,
                                      "Cephalopoda",
                                      "ntr")
```

Results combined are:

```{r, rescephalltable}
knitr::kable(res_table_cephall, digits = 2)
```



## Global xmax for Cephalopoda (all)

So doing the modal approach gave different xmin between baseline and other two;
should go with the largest of those. Though might give quite shallow power law
for baseline.

Alternative is to use xmin for the aggregated data, TODO try that also.

xmax was set independently, so we should select the globally largest for
this species group.

```{r, cephallxmax}
cephall_xmin <- max(res_table_cephall$x_min)
cephall_xmin
cephall_xmax <- max(res_table_cephall$x_max)
cephall_xmax
```

## Cephalopoda (all) baseline with fixed xmin and xmax

```{r, cephallbaselinexmax}
res_cephall_baseline_fix_xmax <-
  determine_xmin_and_fit_mlebins(data_cephall_baseline,
                                 x_min = cephall_xmin,
                                 x_max = cephall_xmax)
```

\clearpage

```{r, cephallbaselineplotxmax}
plot(res_cephall_baseline_fix_xmax,
     xlim_hist = c(0, 60),
     main = "Cephalopoda (all) baseline")
```

## Cephalopoda (all) FG with fixed xmin and xmax

```{r, cephallfgxmax}
res_cephall_fg_fix_xmax <- determine_xmin_and_fit_mlebins(data_cephall_fg,
                                                        x_min = cephall_xmin,
                                                        x_max = cephall_xmax)
```

\clearpage

```{r, cephallfgplotxmax}
plot(res_cephall_fg_fix_xmax,
     xlim_hist = c(0, 60),
     main = "Cephalopoda (all) FG")
```

## Cephalopoda (all) NTR with fixed xmin and xmax

TODO need to recompuate is xmin and
```{r, cephallbaelinexmax}
res_cephall_ntr_fix_xmax <- determine_xmin_and_fit_mlebins(data_cephall_ntr,
                                                         x_min = cephall_xmin,
                                                         x_max = cephall_xmax)
```

```{r, cephallntrplotxmax}
plot(res_cephall_ntr,
     xlim_hist = c(0, 60),
     main = "Cephalopoda (all) NTR")
```

Now to compare the three strata for Cephalopoda (all) with xmax fixed:

```{r, cephallsummfix}
res_table_cephall_fix_xmax <- dplyr::tibble()
res_table_cephall_fix_xmax <- add_row_to_summary_table(res_table_cephall_fix_xmax,
                                      res_cephall_baseline_fix_xmax,
                                      "Cephalopoda",
                                      "Baseline")

res_table_cephall_fix_xmax <- add_row_to_summary_table(res_table_cephall_fix_xmax,
                                      res_cephall_fg_fix_xmax,
                                      "Cephalopoda",
                                      "fg")
res_table_cephall_fix_xmax <- add_row_to_summary_table(res_table_cephall_fix_xmax,
                                      res_cephall_ntr_fix_xmax,
                                      "Cephalopoda",
                                      "ntr")
```

Results combined are:

```{r, rescephalltablexmax}
knitr::kable(res_table_cephall_fix_xmax, digits = 2)
```


TODO then repeat the above for small and large separately, if those results
warrant it. The first baseline plot suggests a natural break, explicitly at
20.89, with fg and ntr saying maybe something similar; 24 might be a sensible
consistent way of breaking up the data.
```{r, cephallbaselinebreak}
dplyr::arrange(data_cephall_baseline, bin_min) %>% a()

dplyr::arrange(data_cephall_fg, bin_min) %>% a()

dplyr::arrange(data_cephall_ntr, bin_min) %>% a()






```{r, stopagain, cache = FALSE, eval = TRUE}
knitr::knit_exit()
```

# Full community could maybe do

TODO Showing that we need the stitching together idea later.


Can delete this once used any info when copying to above, all from x values approach:





# Cephalopoda -- Large

Now doing just the large individuals. Probably should do MLEbin.

TODO and large/small cut off could be 20.

## Cephalopoda large baseline

```{r, cephlargebaseline}
range(x_ceph_large_baseline)

res_ceph_large_baseline <- determine_xmin_and_fit(x_ceph_large_baseline,
                                                  bin_width = 10)

plot(res_ceph_large_baseline,
     xlim_hist = c(0, 100),
     main = "Cephalopoda large baseline")
```

```{r, tablecephlargebaseline, results = "asis"}
summary_mle_table(res_ceph_large_baseline)
```

## Cephalopoda large FG

```{r, cephlargefg}
range(x_ceph_large_fg)

# Increasing bin width here
res_ceph_large_fg <- determine_xmin_and_fit(x_ceph_large_fg,
                                           bin_width = 10)

plot(res_ceph_large_fg,
     xlim_hist = c(0, 100),
     main = "Cephalopoda large FG")
```

```{r, tablecephlargefg, results = "asis"}
summary_mle_table(res_ceph_large_fg)
```

## Cephalopoda large NTR

And for NTR:
```{r, cephlargentr}
range(x_ceph_large_ntr)

res_ceph_large_ntr <- determine_xmin_and_fit(x_ceph_large_ntr,
                                             bin_width = 10)

plot(res_ceph_large_ntr,
     xlim_hist = c(0, 100),
     main = "Cephalopoda large NTR")
```

```{r, tablecephlargentr, results = "asis"}
summary_mle_table(res_ceph_large_ntr)
```

# Cephalopoda -- Small

Now doing just the small individuals. Probably should do MLEbin.

TODO and large/small cut off could be 20.

## Cephalopoda small baseline

```{r, cephsmallbaseline}
range(x_ceph_small_baseline)

res_ceph_small_baseline <- determine_xmin_and_fit(x_ceph_small_baseline,
                                                  bin_width = 1)

plot(res_ceph_small_baseline,
     xlim_hist = c(0, 10),
     main = "Cephalopoda small baseline")
```

```{r, tablecephsmallbaseline, results = "asis"}
summary_mle_table(res_ceph_small_baseline)
```

## Cephalopoda small FG

```{r, cephsmallfg}
range(x_ceph_small_fg)

# Increasing bin width here
res_ceph_small_fg <- determine_xmin_and_fit(x_ceph_small_fg,
                                           bin_width = 1)

plot(res_ceph_small_fg,
     xlim_hist = c(0, 10),
     main = "Cephalopoda small FG")
```

```{r, tablecephsmallfg, results = "asis"}
summary_mle_table(res_ceph_small_fg)
```

## Cephalopoda small NTR

And for NTR:
```{r, cephsmallntr}
range(x_ceph_small_ntr)

res_ceph_small_ntr <- determine_xmin_and_fit(x_ceph_small_ntr,
                                             bin_width = 1)

plot(res_ceph_small_ntr,
     xlim_hist = c(0, 10),
     main = "Cephalopoda small NTR")
```

```{r, tablecephsmallntr, results = "asis"}
summary_mle_table(res_ceph_small_ntr)
```
